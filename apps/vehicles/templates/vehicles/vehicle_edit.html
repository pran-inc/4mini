{% extends "base.html" %}
{% block title %}Edit Vehicle{% endblock %}
{% block content %}

<div class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">Edit Vehicle</h1>
      <p class="muted">車両ページの内容を編集できます。</p>
    </div>

    <div class="page-actions">
      <a class="btn btn-ghost" href="{% url 'vehicle_detail' vehicle.id %}">公開ページを見る →</a>
      <a class="btn btn-ghost" href="{% url 'vehicle_detail' vehicle.id %}">Back</a>
    </div>
  </div>

  <div class="notice-card">
    <div class="notice-card__row">
      <div>
        <div class="notice-card__title">Step2：詳細・画像・パーツ編集</div>
        <div class="notice-card__desc">ここで情報を充実させるほど、検索にも強くなります。</div>
      </div>
      <div class="notice-card__right">
        <a href="{% url 'vehicle_detail' vehicle.id %}">公開ページを見る →</a>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">基本情報</h2>

    <form method="post" enctype="multipart/form-data" id="vehicle-edit-form" class="form">
      {% csrf_token %}

      <div class="form-card">
        {% for field in form.visible_fields %}
          {% if field.name != "images" %}
            <p>
              {{ field.label_tag }}<br>
              {{ field }}
              {{ field.errors }}
              {% if field.help_text %}
                <small class="muted">{{ field.help_text }}</small>
              {% endif %}
            </p>
          {% endif %}
        {% endfor %}

        {% if form.non_field_errors %}
          <div class="form-error">{{ form.non_field_errors }}</div>
        {% endif %}
      </div>

      <div class="section-divider"></div>

      <h2 class="section-title">Images</h2>
      <p class="help">
        ドラッグで並び替え（最大10枚）<br>
        <strong>一番左の画像が自動でメイン</strong>になります（選択は不要）
      </p>

      <input type="hidden" name="image_order_json" id="image_order_json" value="[]">

      <div id="image-grid" class="image-grid">
        {% for img in vehicle.images.all %}
          <div class="img-card" draggable="true" data-id="{{ img.id }}">
            {% if img.thumb %}
              <img class="img-card__img" src="{{ img.thumb.url }}" alt="">
            {% else %}
              <img class="img-card__img" src="{{ img.image.url }}" alt="">
            {% endif %}

            <div class="img-card__meta">
              <div class="js-main-badge img-card__badge"></div>

              <label class="img-card__delete">
                <input type="checkbox" name="delete_image_ids" value="{{ img.id }}" class="js-delete">
                Delete
              </label>
            </div>

            <div class="img-card__hint">Drag to reorder</div>
          </div>
        {% empty %}
          <div class="empty">No images yet.</div>
        {% endfor %}
      </div>

      <div class="subsection">
        <h3 class="subsection-title">Add Images</h3>
        {% if form.images.help_text %}
          <p class="help">{{ form.images.help_text }}</p>
        {% endif %}

        {{ form.images.errors }}
        <div class="file-row">
          {{ form.images }}
        </div>

        <div id="preview-vehicle-images-add" class="preview"></div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Save</button>
        <span class="muted">※ 今日は途中まででもOK。保存すれば、続きは後で編集できます。</span>
      </div>
    </form>
  </div>

  <hr class="hr">

  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Parts</h2>
      <p class="muted">カテゴリ→候補選択 or 自由入力で追加できます。</p>
    </div>

    <div id="js-part-form-wrap" class="form-card">
      {% include "vehicles/_part_form.html" with form=part_form vehicle=vehicle %}
    </div>

    <ul id="js-part-list" class="part-list">
      {% for vp in vehicle_parts %}
        {% include "vehicles/_part_row.html" with vp=vp %}
      {% empty %}
        <li class="empty">まだパーツがありません</li>
      {% endfor %}
    </ul>

    <div class="danger-zone">
      <a class="btn btn-danger-ghost" href="{% url 'vehicle_delete_confirm' vehicle.id %}">この車両を削除</a>
    </div>
  </div>
</div>


<script>
(function(){
  const el = document.getElementById("id_images");
  if (el) {
    el.setAttribute("data-preview","multi");
    el.setAttribute("data-preview-target","#preview-vehicle-images-add");
  }
  if (window.bindFilePreviews) window.bindFilePreviews(document);
})();
</script>

<script>
(function() {
  const grid = document.getElementById("image-grid");
  const orderInput = document.getElementById("image_order_json");
  const form = document.getElementById("vehicle-edit-form");
  if (!grid) return;

  let dragged = null;

  function cards() {
    return Array.from(grid.querySelectorAll(".img-card"));
  }

  function serializeOrder() {
    const ids = cards().map(el => Number(el.dataset.id));
    orderInput.value = JSON.stringify(ids);
  }

  function paintMainUI() {
    const cs = cards();
    cs.forEach((c, idx) => {
      c.style.border = (idx === 0) ? "2px solid #111" : "2px solid #ddd";
      const badge = c.querySelector(".js-main-badge");
      if (badge) badge.textContent = (idx === 0) ? "★ Main (leftmost)" : "";
    });
  }

  function paintDeleteState() {
    cards().forEach((card) => {
      const chk = card.querySelector("input.js-delete");
      if (!chk) return;

      const old = card.querySelector(".js-delete-badge");
      if (old) old.remove();

      if (chk.checked) {
        card.style.opacity = "0.35";
        card.style.filter = "grayscale(100%)";
        card.setAttribute("draggable", "false");
        card.style.cursor = "not-allowed";

        const badge = document.createElement("div");
        badge.className = "js-delete-badge";
        badge.textContent = "削除予定";
        badge.style.cssText = "margin-top:6px; font-size:12px; font-weight:bold; opacity:0.9;";
        card.appendChild(badge);
      } else {
        card.style.opacity = "1.0";
        card.style.filter = "none";
        card.setAttribute("draggable", "true");
        card.style.cursor = "grab";
      }
    });
  }

  serializeOrder();
  paintMainUI();
  paintDeleteState();

  grid.addEventListener("change", (e) => {
    if (e.target && e.target.classList && e.target.classList.contains("js-delete")) {
      paintDeleteState();
      paintMainUI();
      serializeOrder();
    }
  });

  grid.addEventListener("dragstart", (e) => {
    const card = e.target.closest(".img-card");
    if (!card) return;

    const chk = card.querySelector("input.js-delete");
    if (chk && chk.checked) return;

    dragged = card;
    e.dataTransfer.effectAllowed = "move";
  });

  grid.addEventListener("dragover", (e) => {
    e.preventDefault();
    const over = e.target.closest(".img-card");
    if (!over || !dragged || over === dragged) return;

    const overChk = over.querySelector("input.js-delete");
    if (overChk && overChk.checked) return;

    const rect = over.getBoundingClientRect();
    const after = (e.clientY - rect.top) > (rect.height / 2);
    if (after) {
      over.after(dragged);
    } else {
      over.before(dragged);
    }
  });

  grid.addEventListener("dragend", () => {
    dragged = null;
    serializeOrder();
    paintMainUI();
    paintDeleteState();
  });

  form.addEventListener("submit", () => {
    serializeOrder();
  });
})();
</script>

<script>
(function(){
  const wrap = document.getElementById("js-part-form-wrap");
  const list = document.getElementById("js-part-list");
  if (!wrap || !list) return;

  function getCSRF() {
    const el = wrap.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : "";
  }

  function initPartForm(container) {
    const categoryEl = container.querySelector("#id_category");
    const partEl = container.querySelector("#id_part");
    const freeEl = container.querySelector("#id_part_free_text");

    const toggleEl = container.querySelector("#js-free-toggle");
    const toggleLabelEl = container.querySelector("#js-free-toggle-label");
    const selectWrap = container.querySelector("#js-part-select-wrap");
    const freeWrap = container.querySelector("#js-part-free-wrap");

    if (!categoryEl || !partEl || !freeEl || !toggleEl || !toggleLabelEl || !selectWrap || !freeWrap) return;

    let lastPartCount = 0;
    let focusFreeNext = false;

    function lock(el, locked) {
      el.disabled = !!locked;
      el.style.opacity = locked ? "0.5" : "1.0";
    }

    function updateToggleLabel() {
      const hasCategory = !!categoryEl.value;

      if (!hasCategory) {
        toggleLabelEl.textContent = "自由入力にする（カテゴリ選択後）";
        return;
      }
      if (lastPartCount === 0) {
        toggleLabelEl.textContent = "自由入力にする（候補なし：自動ON）";
        return;
      }
      toggleLabelEl.textContent = "自由入力にする";
    }

    function applyModeUI() {
      const hasCategory = !!categoryEl.value;
      const isFree = !!toggleEl.checked;

      lock(toggleEl, !hasCategory);

      if (!hasCategory) {
        toggleEl.checked = false;
        selectWrap.style.display = "block";
        freeWrap.style.display = "none";

        partEl.value = "";
        freeEl.value = "";

        lock(partEl, true);
        lock(freeEl, true);

        updateToggleLabel();
        return;
      }

      updateToggleLabel();

      if (isFree) {
        selectWrap.style.display = "none";
        freeWrap.style.display = "block";

        partEl.value = "";
        lock(partEl, true);
        lock(freeEl, false);

        if (focusFreeNext) {
          focusFreeNext = false;
          setTimeout(() => { try { freeEl.focus(); } catch(e) {} }, 0);
        }
      } else {
        selectWrap.style.display = "block";
        freeWrap.style.display = "none";

        freeEl.value = "";
        lock(partEl, false);
        lock(freeEl, true);
      }
    }

    function setPartOptions(items) {
      lastPartCount = items.length;

      partEl.innerHTML = "";
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "（部品を選択）";
      partEl.appendChild(empty);

      items.forEach((it) => {
        const opt = document.createElement("option");
        opt.value = String(it.id);
        opt.textContent = it.name;
        partEl.appendChild(opt);
      });

      freeEl.placeholder = (items.length > 0)
        ? "（選択肢に無い場合のみ入力）"
        : "（このカテゴリに部品が無いので自由入力してください）";

      if (categoryEl.value && items.length === 0) {
        toggleEl.checked = true;
        partEl.value = "";
        focusFreeNext = true;
      }

      applyModeUI();
    }

    async function fetchParts(categoryId) {
      if (!categoryId) {
        setPartOptions([]);
        return;
      }
      const url = new URL("{% url 'api_parts_by_category' %}", window.location.origin);
      url.searchParams.set("category_id", categoryId);

      const res = await fetch(url.toString(), { headers: {"Accept":"application/json"} });
      if (!res.ok) {
        setPartOptions([]);
        return;
      }
      const data = await res.json();
      setPartOptions(data.results || []);
    }

    if (!container.dataset.bound) {
      container.dataset.bound = "1";

      toggleEl.addEventListener("change", () => {
        if (toggleEl.checked) focusFreeNext = true;
        applyModeUI();
      });

      categoryEl.addEventListener("change", () => {
        toggleEl.checked = false;
        partEl.value = "";
        freeEl.value = "";
        focusFreeNext = false;
        fetchParts(categoryEl.value);
      });
    }

    fetchParts(categoryEl.value);
  }

  initPartForm(wrap);

  document.addEventListener("submit", async (e) => {
    const form = e.target.closest("#js-part-form");
    if (!form) return;
    e.preventDefault();

    const url = form.getAttribute("action");
    const body = new FormData(form);

    const res = await fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF() },
      body,
    });

    const data = await res.json();

    if (!data.ok) {
      wrap.innerHTML = data.form_html;
      initPartForm(wrap);
      return;
    }

    wrap.innerHTML = data.form_html;
    initPartForm(wrap);

    list.insertAdjacentHTML("afterbegin", data.row_html);

    const empty = list.querySelector("li.empty");
    if (empty) empty.remove();
  });

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-part-delete");
    if (!btn) return;

    const url = btn.dataset.url;
    const li = btn.closest("li[data-part-id]");
    if (!url || !li) return;

    const res = await fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF() },
    });

    const data = await res.json();
    if (data.ok) {
      li.remove();
      if (!list.querySelector("li[data-part-id]")) {
        list.insertAdjacentHTML("beforeend", "<li class='empty'>まだパーツがありません</li>");
      }
    }
  });
})();
</script>

{% endblock %}
