{% extends "base.html" %}
{% block title %}{{ vehicle.title }}{% endblock %}
{% block content %}

<h1>{{ vehicle.title }}</h1>
<p>{{ vehicle.model.maker }} {{ vehicle.model.name }}</p>

{% if user.is_authenticated and user.id == vehicle.owner_id %}
  <p><a href="{% url 'vehicle_edit' vehicle.id %}">Edit vehicle</a></p>
{% endif %}

<hr>

<!-- ãƒ¡ã‚¤ãƒ³ç”»åƒï¼ˆis_mainå„ªå…ˆã§prefetchæ¸ˆã¿ãªã‚‰ all.0 ãŒãƒ¡ã‚¤ãƒ³ï¼‰ -->
{% if vehicle.images.all|length %}
  <div>
    <img src="{{ vehicle.images.all.0.image.url }}"
         alt=""
         style="width:100%; max-width:720px; height:420px; object-fit:cover; border-radius:12px;">
  </div>

  {% if vehicle.images.all|length > 1 %}
    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
      {% for img in vehicle.images.all|slice:"1:" %}
        <img src="{{ img.image.url }}" alt=""
             style="width:140px; height:100px; object-fit:cover; border-radius:10px;">
      {% endfor %}
    </div>
  {% endif %}
{% else %}
  <p>No images.</p>
{% endif %}

<hr>

<h2>Details</h2>
<ul>
  {% if vehicle.year %}<li>Year: {{ vehicle.year }}</li>{% endif %}
  {% if vehicle.custom_summary %}<li>Custom: {{ vehicle.custom_summary }}</li>{% endif %}
</ul>

{% if vehicle.description %}
  <p>{{ vehicle.description|linebreaksbr }}</p>
{% endif %}

<hr>

<!-- ã„ã„ã­ / ãŠæ°—ã«å…¥ã‚Šï¼ˆã‚ãªãŸã®æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰ -->
{% if user.is_authenticated %}
  <button class="js-reaction"
          data-url="/reactions/toggle/"
          data-type="vehicle"
          data-id="{{ vehicle.id }}"
          data-reaction="like"
          type="button">
    ğŸ‘ Like (<span class="js-count">{{ like_count|default:0 }}</span>)
  </button>

  <button class="js-reaction"
          data-url="/reactions/toggle/"
          data-type="vehicle"
          data-id="{{ vehicle.id }}"
          data-reaction="favorite"
          type="button"
          style="margin-left:10px;">
    â­ Favorite (<span class="js-count">{{ favorite_count|default:0 }}</span>)
  </button>
{% else %}
  <p><a href="{% url 'login' %}?next={% url 'vehicle_detail' vehicle.id %}">Login</a> to like/favorite.</p>
{% endif %}

<script>
(function() {
  const buttons = document.querySelectorAll(".js-reaction");
  buttons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const url = btn.dataset.url;

      const payload = new URLSearchParams();
      payload.append("content_type", btn.dataset.type); // ã‚ãªãŸã®APIä»•æ§˜ã«åˆã‚ã›ã¦
      payload.append("object_id", btn.dataset.id);
      payload.append("reaction_type", btn.dataset.reaction);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: payload.toString(),
      });

      if (res.redirected) {
        window.location.href = res.url;
        return;
      }
      if (!res.ok) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        return;
      }

      const data = await res.json();

      // data.count ã‚’è¿”ã™å®Ÿè£…ãªã‚‰ã“ã“ã§åæ˜ 
      const countEl = btn.querySelector(".js-count");
      if (countEl && typeof data.count !== "undefined") {
        countEl.textContent = data.count;
      }
      // data.active ã‚’è¿”ã™ãªã‚‰è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹
      if (typeof data.active !== "undefined") {
        btn.style.opacity = data.active ? "1.0" : "0.6";
      }
    });
  });
})();
</script>

{% endblock %}
