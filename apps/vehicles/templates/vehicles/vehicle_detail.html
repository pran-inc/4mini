{% extends "base.html" %}
{% block title %}{{ vehicle.title }}{% endblock %}
{% block content %}

<h1>{{ vehicle.title }}</h1>
<p>{{ vehicle.model.maker }} {{ vehicle.model.name }}</p>

{% if user.is_authenticated and user.id == vehicle.owner_id %}
  <p><a href="{% url 'vehicle_edit' vehicle.id %}">Edit vehicle</a></p>
{% endif %}

<hr>

<!-- ã„ã„ã­ / ãŠæ°—ã«å…¥ã‚Šï¼ˆã‚ãªãŸã®æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰ -->
{% if user.is_authenticated %}
  <button class="js-reaction"
          data-url="/reactions/toggle/"
          data-type="vehicle"
          data-id="{{ vehicle.id }}"
          data-reaction="like"
          type="button">
    ğŸ‘ Like (<span class="js-count">{{ like_count|default:0 }}</span>)
  </button>

  <button class="js-reaction"
          data-url="/reactions/toggle/"
          data-type="vehicle"
          data-id="{{ vehicle.id }}"
          data-reaction="favorite"
          type="button"
          style="margin-left:10px;">
    â­ Favorite (<span class="js-count">{{ favorite_count|default:0 }}</span>)
  </button>
{% else %}
  <p><a href="{% url 'login' %}?next={% url 'vehicle_detail' vehicle.id %}">Login</a> to like/favorite.</p>
{% endif %}


<hr>

<!-- ========================= -->
<!-- ãƒ¡ã‚¤ãƒ³ç”»åƒï¼šã‚µãƒ ãƒã‚¯ãƒªãƒƒã‚¯ã§å·®ã—æ›¿ãˆ -->
<!-- ========================= -->
{% if vehicle.main_image %}
  <div style="max-width:720px;">
    <img id="js-main-image"
         src="{{ vehicle.main_image.image.url }}"
         alt=""
         style="width:100%; height:420px; object-fit:cover; border-radius:12px;">

    <!-- ã‚µãƒ ãƒ -->
    {% if vehicle.images.all|length %}
      <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for img in vehicle.images.all %}
          {% if img.thumb %}
            <img class="js-thumb"
                 src="{{ img.thumb.url }}"
                 data-full="{{ img.image.url }}"
                 alt=""
                 style="width:140px; height:100px; object-fit:cover; border-radius:10px; cursor:pointer;
                        border:2px solid {% if img.id == vehicle.main_image_id %}#111{% else %}transparent{% endif %};">
          {% else %}
            <img class="js-thumb"
                 src="{{ img.image.url }}"
                 data-full="{{ img.image.url }}"
                 alt=""
                 style="width:140px; height:100px; object-fit:cover; border-radius:10px; cursor:pointer;
                        border:2px solid {% if img.id == vehicle.main_image_id %}#111{% else %}transparent{% endif %};">
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% else %}
  <p>No images.</p>
{% endif %}

{% if vehicle.specs %}
  <h3>More specs</h3>
  <ul>
    {% for k, v in vehicle.specs.items %}
      <li>{{ k }}: {{ v }}</li>
    {% endfor %}
  </ul>
{% endif %}

<script>
(function() {
  const mainImg = document.getElementById("js-main-image");
  if (!mainImg) return;

  const thumbs = document.querySelectorAll(".js-thumb");
  if (!thumbs.length) return;

  function clearBorders() {
    thumbs.forEach(t => t.style.border = "2px solid transparent");
  }

  thumbs.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      const full = thumb.dataset.full;
      if (!full) return;

      // ãƒ¡ã‚¤ãƒ³å·®ã—æ›¿ãˆ
      mainImg.src = full;

      // é¸æŠæ ã®æ›´æ–°
      clearBorders();
      thumb.style.border = "2px solid #111";
    });
  });
})();
</script>

<hr>

<h2>Details</h2>


<a href="{% url 'profile_detail' vehicle.owner.username %}">
  {{ vehicle.owner.username }}
</a>

<ul>
  {% if vehicle.year %}<li>Year: {{ vehicle.year }}</li>{% endif %}
  {% if vehicle.custom_summary %}<li>Custom: {{ vehicle.custom_summary }}</li>{% endif %}
</ul>

{% if vehicle.description %}
  <p>{{ vehicle.description|linebreaksbr }}</p>
{% endif %}

<hr>

<h2>Custom Parts</h2>

{% if user.is_authenticated and user.id == vehicle.owner_id %}
  <p><a href="{% url 'vehicle_edit' vehicle.id %}#parts">+ Add Part</a></p>
{% endif %}

{% if parts %}
  {% regroup parts by part.category as grouped %}
  {% for g in grouped %}
    <h3 style="margin-top:14px;">{{ g.grouper.name }}</h3>
    <ul>
      {% for vp in g.list %}
        <li style="margin-bottom:6px;">
        <strong>
          {% if vp.part %}
            {{ vp.part.name }}
          {% else %}
            {{ vp.part_free_text }}
          {% endif %}
        </strong>          {% if vp.maker %} / {{ vp.maker.name }}{% endif %}
          {% if vp.model_number %} / {{ vp.model_number }}{% endif %}
          {% if vp.spec %} / {{ vp.spec }}{% endif %}
          {% if vp.note %}<div style="opacity:0.85;">{{ vp.note|linebreaksbr }}</div>{% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endfor %}
{% else %}
  <p style="opacity:0.7;">No custom parts yet.</p>
{% endif %}

{% if user.is_authenticated and user.id == vehicle.owner_id %}
  <p>
    <a href="{% url 'vehicle_edit' vehicle.id %}">Edit</a>
    | <a href="{% url 'vehicle_delete_confirm' vehicle.id %}">Delete</a>
  </p>
{% endif %}


<script>
(function() {
  const buttons = document.querySelectorAll(".js-reaction");
  buttons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const url = btn.dataset.url;

      const payload = new URLSearchParams();
      payload.append("content_type", btn.dataset.type);
      payload.append("object_id", btn.dataset.id);
      payload.append("reaction_type", btn.dataset.reaction);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: payload.toString(),
      });

      if (res.redirected) {
        window.location.href = res.url;
        return;
      }
      if (!res.ok) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        return;
      }

      const data = await res.json();

      const countEl = btn.querySelector(".js-count");
      if (countEl && typeof data.count !== "undefined") {
        countEl.textContent = data.count;
      }
      if (typeof data.active !== "undefined") {
        btn.style.opacity = data.active ? "1.0" : "0.6";
      }
    });
  });
})();
</script>

{% endblock %}
