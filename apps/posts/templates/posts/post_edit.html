{% extends "base.html" %}
{% block title %}Edit Post{% endblock %}
{% block content %}
<h1>Edit Post</h1>

<p><a href="{% url 'post_detail' post.id %}">Back</a></p>

<form method="post" enctype="multipart/form-data" id="post-edit-form">
  {% csrf_token %}

  {{ form.as_p }}

  <h2>Images</h2>
  <p style="opacity:0.8;">
    ドラッグで並び替え（最大10枚）<br>
    <strong>一番左の画像が自動でメイン</strong>になります（選択は不要）
  </p>

  <input type="hidden" name="image_order_json" id="image_order_json" value="[]">

  <div id="image-grid" style="
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap:12px;
    margin-bottom:12px;
  ">
    {% for img in post.images.all %}
      <div class="img-card"
           draggable="true"
           data-id="{{ img.id }}"
           style="
             border:2px solid #ddd;
             padding:8px;
             border-radius:10px;
             background:#fff;
             cursor:grab;
           ">
        {% if img.thumb %}
          <img src="{{ img.thumb.url }}" alt=""
               style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
        {% else %}
          <img src="{{ img.image.url }}" alt=""
               style="width:100%; height:140px; object-fit:cover; border-radius:8px;">
        {% endif %}

        <div style="margin-top:6px; display:flex; justify-content:space-between; gap:8px; align-items:center;">
          <div class="js-main-badge" style="font-size:12px; opacity:0.75;"></div>

          <label style="font-size:12px;">
            <input type="checkbox" name="delete_image_ids" value="{{ img.id }}" class="js-delete">
            Delete
          </label>
        </div>

        <div style="opacity:0.6; font-size:11px; margin-top:4px;">
          Drag to reorder
        </div>
      </div>
    {% empty %}
      <p>No images yet.</p>
    {% endfor %}
  </div>

  <h3>Add Images</h3>
  <p>{{ form.images.help_text }}</p>
  {{ form.images.errors }}
  {{ form.images }}

  <div style="margin-top:16px;">
    <button type="submit">Save</button>
  </div>
</form>

<p style="margin-top:18px;">
  <a href="{% url 'post_delete_confirm' post.id %}">この投稿を削除</a>
</p>

<script>
(function() {
  const grid = document.getElementById("image-grid");
  const orderInput = document.getElementById("image_order_json");
  const form = document.getElementById("post-edit-form");
  if (!grid) return;

  let dragged = null;

  function cards() {
    return Array.from(grid.querySelectorAll(".img-card"));
  }

  function serializeOrder() {
    const ids = cards().map(el => Number(el.dataset.id));
    orderInput.value = JSON.stringify(ids);
  }

  function paintMainUI() {
    const cs = cards();
    cs.forEach((c, idx) => {
      c.style.border = (idx === 0) ? "2px solid #111" : "2px solid #ddd";
      const badge = c.querySelector(".js-main-badge");
      if (badge) badge.textContent = (idx === 0) ? "★ Main (leftmost)" : "";
    });
  }

  function paintDeleteState() {
    cards().forEach((card) => {
      const chk = card.querySelector("input.js-delete");
      if (!chk) return;

      const old = card.querySelector(".js-delete-badge");
      if (old) old.remove();

      if (chk.checked) {
        card.style.opacity = "0.35";
        card.style.filter = "grayscale(100%)";
        card.setAttribute("draggable", "false");
        card.style.cursor = "not-allowed";

        const badge = document.createElement("div");
        badge.className = "js-delete-badge";
        badge.textContent = "削除予定";
        badge.style.cssText = "margin-top:6px; font-size:12px; font-weight:bold; opacity:0.9;";
        card.appendChild(badge);
      } else {
        card.style.opacity = "1.0";
        card.style.filter = "none";
        card.setAttribute("draggable", "true");
        card.style.cursor = "grab";
      }
    });
  }

  serializeOrder();
  paintMainUI();
  paintDeleteState();

  grid.addEventListener("change", (e) => {
    if (e.target && e.target.classList && e.target.classList.contains("js-delete")) {
      paintDeleteState();
      paintMainUI();
      serializeOrder();
    }
  });

  grid.addEventListener("dragstart", (e) => {
    const card = e.target.closest(".img-card");
    if (!card) return;

    const chk = card.querySelector("input.js-delete");
    if (chk && chk.checked) return;

    dragged = card;
    e.dataTransfer.effectAllowed = "move";
  });

  grid.addEventListener("dragover", (e) => {
    e.preventDefault();
    const over = e.target.closest(".img-card");
    if (!over || !dragged || over === dragged) return;

    const overChk = over.querySelector("input.js-delete");
    if (overChk && overChk.checked) return;

    const rect = over.getBoundingClientRect();
    const after = (e.clientY - rect.top) > (rect.height / 2);
    if (after) {
      over.after(dragged);
    } else {
      over.before(dragged);
    }
  });

  grid.addEventListener("dragend", () => {
    dragged = null;
    serializeOrder();
    paintMainUI();
    paintDeleteState();
  });

  form.addEventListener("submit", () => {
    serializeOrder();
  });
})();
</script>

{% endblock %}
